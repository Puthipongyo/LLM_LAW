import os
import torch
import pandas as pd
from transformers import AutoTokenizer, AutoModelForCausalLM, BitsAndBytesConfig
from huggingface_hub import HfFolder

# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô CUDA memory fragmentation
os.environ["PYTORCH_CUDA_ALLOC_CONF"] = "expandable_segments:True"
torch.cuda.empty_cache()

# 1. Load model & tokenizer
model_name = "scb10x/llama3.1-typhoon2-70b-instruct"
token = HfFolder.get_token()  # ‡πÉ‡∏ä‡πâ token ‡∏ó‡∏µ‡πà login ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ

quant_config = BitsAndBytesConfig(
    load_in_4bit=True,
    bnb_4bit_compute_dtype=torch.float16,
    bnb_4bit_use_double_quant=True,
    bnb_4bit_quant_type="nf4"
)

tokenizer = AutoTokenizer.from_pretrained(model_name, use_fast=True, token=token)
model = AutoModelForCausalLM.from_pretrained(
    model_name,
    quantization_config=quant_config,
    device_map="auto",
    torch_dtype=torch.float16,
    token=token
)

# 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏à‡∏≤‡∏Å context
def ask_law_question(question, context, return_text=False):
    prompt = f"""<|user|>
    ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:

    \"\"\"{context}\"\"\"

    ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: {question}
    """
    inputs = tokenizer(prompt, return_tensors="pt", truncation=True, max_length=2048)
    inputs = {k: v.to(model.device) for k, v in inputs.items()}

    with torch.no_grad():
        outputs = model.generate(**inputs, max_new_tokens=600, do_sample=False)
        response = tokenizer.decode(outputs[0], skip_special_tokens=True)

    # ‡∏ï‡∏±‡∏î prompt ‡∏≠‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
    answer_only = response.split("‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°:")[-1].strip()

    print("üìå ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•:\n", answer_only)
    print("=" * 80)

    if return_text:
        return answer_only

# 3. Main process
if __name__ == "__main__":
    df = pd.read_csv("/workspace/test/data_case_100.csv", encoding="utf-8-sig")

    if "text" not in df.columns:
        raise ValueError("‡πÑ‡∏°‡πà‡∏û‡∏ö column 'text' ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV")

    # ‡∏£‡∏ß‡∏° context ‡∏à‡∏≤‡∏Å 3 ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å
    context = ""
    for i, row in df.head(3).iterrows():
        context += f"[{i}] {row['text']}\n\n"

    # ‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
    # ask_law_question("‡∏à‡∏≤‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ ‡∏°‡∏µ‡∏°‡∏≤‡∏ï‡∏£‡∏≤‡πÑ‡∏´‡∏ô‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏ö‡πâ‡∏≤‡∏á", context)
    ask_law_question("""
        ‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô‡πÇ‡∏â‡∏ô‡∏î‡∏ó‡∏µ‡πà 499 ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà 56 ‡πÑ‡∏£‡πà 68 ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á‡∏ô‡∏≤‡∏¢‡∏ã‡∏≠‡∏ö‡∏¥‡∏î‡∏≤‡∏ã‡∏∂‡πà‡∏á‡∏ñ‡∏∂‡∏á‡πÅ‡∏Å‡πà‡∏Å‡∏£‡∏£‡∏°‡πÇ‡∏î‡∏¢‡∏°‡∏¥‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏û‡∏¥‡∏ô‡∏±‡∏¢‡∏Å‡∏£‡∏£‡∏°‡πÇ‡∏à‡∏ó‡∏Å‡πå‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏£‡∏î‡∏Å 1 ‡πÉ‡∏ô 13 ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà 4 ‡πÑ‡∏£‡πà 1 ‡∏á‡∏≤‡∏ô 29 ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏≤ ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏û‡∏≤‡∏Å‡∏©‡∏≤‡πÉ‡∏´‡πâ‡πÇ‡∏à‡∏ó‡∏Å‡πå‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏°‡∏£‡∏î‡∏Å‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏à‡∏≥‡πÄ‡∏•‡∏¢
    ‡∏à‡∏≥‡πÄ‡∏•‡∏¢‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ‡∏ß‡πà‡∏≤ ‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ö‡πà‡∏á‡∏°‡∏£‡∏î‡∏Å‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ú‡∏π‡πâ‡∏ï‡∏≤‡∏¢‡πÑ‡∏ß‡πâ ‡πÇ‡∏à‡∏ó‡∏Å‡πå‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á 1 ‡πÑ‡∏£‡πà 3 ‡∏á‡∏≤‡∏ô 14 ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏≤‡πÄ‡∏®‡∏© ‡∏Ñ‡∏î‡∏µ‡πÇ‡∏à‡∏ó‡∏Å‡πå‡∏Ç‡∏≤‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏£‡∏î‡∏Å
    ‡∏ô‡∏≤‡∏á‡∏ô‡∏¥‡πà‡∏° ‡πÇ‡∏ã‡πä‡∏∞‡∏™‡∏•‡∏≤‡∏° ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏•‡∏∞‡∏°‡∏≤‡∏£‡∏î‡∏≤‡∏ú‡∏π‡πâ‡πÅ‡∏ó‡∏ô‡πÇ‡∏î‡∏¢‡∏ä‡∏≠‡∏ö‡∏ò‡∏£‡∏£‡∏°‡∏Ç‡∏≠‡∏á‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡πÅ‡∏™‡∏á‡∏ó‡∏≠‡∏á ‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á‡∏ã‡∏≤‡∏ü‡∏µ‡∏¢‡∏∞ ‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏≠‡∏≤‡∏°‡∏µ‡πÄ‡∏ô‡∏≤‡∏∞ ‡∏ô‡∏≤‡∏á‡∏ó‡∏≠‡∏á‡∏î‡∏µ ‡∏ô‡∏≤‡∏¢‡∏™‡∏ß‡πà‡∏≤‡∏á‡∏£‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏î‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ö‡πà‡∏á‡∏°‡∏£‡∏î‡∏Å‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏∞‡∏†‡∏£‡∏¥‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏ö‡∏∏‡∏ï‡∏£‡πÄ‡∏à‡πâ‡∏≤‡∏°‡∏£‡∏î‡∏Å
    ‡πÑ‡∏î‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏ß‡πà‡∏≤ ‡∏ô‡∏≤‡∏¢‡∏ã‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏°‡∏£‡∏î‡∏Å‡∏°‡∏µ‡∏†‡∏£‡∏¥‡∏¢‡∏≤ 2 ‡∏Ñ‡∏ô ‡∏Ñ‡∏∑‡∏≠‡∏ô‡∏≤‡∏á‡πÄ‡∏ä‡∏¢ ‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡∏á‡∏ô‡∏¥‡πà‡∏° ‡∏°‡∏µ‡∏ö‡∏∏‡∏ï‡∏£‡∏£‡∏ß‡∏° 12 ‡∏Ñ‡∏ô ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏°‡∏£‡∏î‡∏Å‡∏ï‡∏≤‡∏¢ ‡∏ö‡∏∏‡∏ï‡∏£‡∏ó‡∏±‡πâ‡∏á 12 ‡∏Ñ‡∏ô ‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ô‡∏≤‡∏°‡∏ó‡∏≥‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ö‡πà‡∏á‡∏°‡∏£‡∏î‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ‡∏•.1 ‡∏ô‡∏≤‡∏á‡∏ô‡∏¥‡πà‡∏° ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¢‡∏≤‡∏ô
    ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏î‡∏µ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏°‡∏≤‡∏ï‡∏£‡∏≤‡πÅ‡∏û‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á (‡∏ö‡∏≠‡∏Å‡πÄ‡πÄ‡∏Ñ‡πà‡∏°‡∏≤‡∏ï‡∏£‡∏≤)
    """, context)
