import os
import torch
import pandas as pd
from transformers import AutoTokenizer, AutoModelForCausalLM, BitsAndBytesConfig
from huggingface_hub import HfFolder

# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô CUDA memory fragmentation
os.environ["PYTORCH_CUDA_ALLOC_CONF"] = "expandable_segments:True"
torch.cuda.empty_cache()

# 1. Load model & tokenizer
model_name = "scb10x/llama3.1-typhoon2-70b"
token = HfFolder.get_token()  # ‡πÉ‡∏ä‡πâ token ‡∏ó‡∏µ‡πà login ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ

quant_config = BitsAndBytesConfig(
    load_in_4bit=True,
    bnb_4bit_compute_dtype=torch.float16,
    bnb_4bit_use_double_quant=True,
    bnb_4bit_quant_type="nf4"
)

tokenizer = AutoTokenizer.from_pretrained(model_name, use_fast=True, token=token)
model = AutoModelForCausalLM.from_pretrained(
    model_name,
    quantization_config=quant_config,
    device_map="auto",
    torch_dtype=torch.float16,
    token=token
)

# 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏à‡∏≤‡∏Å context
def ask_law_question(question, context, return_text=False):
    prompt = f"""<|user|>
    ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:

    \"\"\"{context}\"\"\"

    ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: {question}
    """
    inputs = tokenizer(prompt, return_tensors="pt", truncation=True, max_length=2048)
    inputs = {k: v.to(model.device) for k, v in inputs.items()}

    with torch.no_grad():
        outputs = model.generate(**inputs, max_new_tokens=600, do_sample=False)
        response = tokenizer.decode(outputs[0], skip_special_tokens=True)

    # ‡∏ï‡∏±‡∏î prompt ‡∏≠‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
    answer_only = response.split("‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°:")[-1].strip()

    print("üìå ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°:", question)
    print("üìå ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•:\n", answer_only)
    print("=" * 80)

    if return_text:
        return answer_only

# 3. Main process
if __name__ == "__main__":
    df = pd.read_csv("/workspace/test/Extracted_Law_CSV.csv", encoding="utf-8-sig")

    if "text" not in df.columns:
        raise ValueError("‡πÑ‡∏°‡πà‡∏û‡∏ö column 'text' ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV")

    # ‡∏£‡∏ß‡∏° context ‡∏à‡∏≤‡∏Å 3 ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å
    context = ""
    for i, row in df.head(3).iterrows():
        context += f"[{i}] {row['text']}\n\n"

    # ‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
    # ask_law_question("‡∏à‡∏≤‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ ‡∏°‡∏µ‡∏°‡∏≤‡∏ï‡∏£‡∏≤‡πÑ‡∏´‡∏ô‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏ö‡πâ‡∏≤‡∏á", context)
    ask_law_question("""
    ‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ö‡∏±‡∏ç‡∏ç‡∏±‡∏ï‡∏¥‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏£‡∏±‡∏ê‡∏ò‡∏£‡∏£‡∏°‡∏ô‡∏π‡∏ç‡∏ß‡πà‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏± ‡πâ‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏†‡∏≤‡∏ú‡∏π ‡πâ‡πÅ‡∏ó‡∏ô‡∏£‡∏≤‡∏©‡∏é‡∏£  ‡∏û.‡∏®.  ‡πí‡πï‡πñ‡πë  
‡∏°‡∏≤‡∏ï‡∏£‡∏≤  ‡πë‡πñ‡πô  ‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏ó‡∏ö‡∏±‡∏ç‡∏ç‡∏±‡∏ï‡∏¥‡∏ó‡∏µ ‡πà‡πÉ‡∏´‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏ú‡∏π ‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏£‡∏£‡∏Ñ‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ó‡∏µ ‡πà‡∏™‡πà‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á‡∏ï‡∏ô‡∏•‡∏á‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á 
‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏± ‡πâ‡∏á‡∏ô‡∏± ‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π ‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡∏¥‡∏ò‡∏µ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏≤‡∏ç‡∏≤  ‡πÄ‡∏ô‡∏∑ ‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á  
‡∏ú‡∏π ‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏£‡∏£‡∏Ñ‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏± ‡πâ‡∏á  ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏Å‡∏µ ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö
 ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏± ‡πâ‡∏á‡∏Å‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ú‡∏π ‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£  ‡∏ú‡∏π ‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏£‡∏£‡∏Ñ‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏¢‡πà‡∏≠‡∏°‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö 
‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á  ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Ñ‡∏î‡∏µ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏± ‡πâ‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏±‡∏ê‡∏ò‡∏£‡∏£‡∏°‡∏ô‡∏π‡∏ç  ‡∏°‡∏≤‡∏ï‡∏£‡∏≤  ‡πí‡πí‡πï  ‡πÅ‡∏•‡∏∞‡∏°‡∏≤‡∏ï‡∏£‡∏≤  ‡πí‡πí‡πñ  ‡∏ß‡∏£‡∏£‡∏Ñ‡πÄ‡∏à‡πá‡∏î   
‡∏°‡∏∏ ‡πà‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏û‡∏∑ ‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏± ‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÇ‡∏î‡∏¢‡∏™‡∏∏‡∏à‡∏£‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏µ ‡πà‡∏¢‡∏á‡∏ò‡∏£‡∏£‡∏°  ‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥ ‡πâ‡∏ô‡πÑ‡∏õ‡πÇ‡∏î‡∏¢‡πÄ‡∏£‡πá‡∏ß  ‡∏à‡∏∂‡∏á‡∏ö‡∏±‡∏ç‡∏ç‡∏±‡∏ï‡∏¥
 ‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏î‡∏¢‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ ‡πà‡πÅ‡∏•‡∏∞‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏± ‡πâ‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Ñ‡∏î‡∏µ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏± ‡πâ‡∏á‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏∞‡πÇ‡∏à‡∏ó‡∏Å‡πå 
‡∏ï‡πà‡∏≠‡∏®‡∏≤‡∏•‡∏é‡∏µ‡∏Å‡∏≤‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á  ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ï‡πà‡∏™‡∏ß‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤  ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Ñ‡∏î‡∏µ‡∏≠‡∏≤‡∏ç‡∏≤‡∏ï‡∏≤‡∏°‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ö‡∏±‡∏ç‡∏ç‡∏±‡∏ï‡∏¥ 
‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏£‡∏±‡∏ê‡∏ò‡∏£‡∏£‡∏°‡∏ô‡∏π‡∏ç‡∏ß‡πà‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏± ‡πâ‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏†‡∏≤‡∏ú‡∏π ‡πâ‡πÅ‡∏ó‡∏ô‡∏£‡∏≤‡∏©‡∏é‡∏£  ‡∏û.‡∏®.  ‡πí‡πï‡πñ‡πë  ‡∏°‡∏≤‡∏ï‡∏£‡∏≤  ‡πë‡πñ‡πô  ‡πÅ‡∏•‡∏∞ 
‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Ñ‡∏î‡∏µ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏± ‡πâ‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏±‡∏ê‡∏ò‡∏£‡∏£‡∏°‡∏ô‡∏π‡∏ç‡∏à‡∏∂‡∏á‡∏°‡∏µ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏£‡∏°‡∏ì‡πå‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô  ‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ú‡∏π ‡πâ‡∏°‡∏µ‡∏≠‡∏≥‡∏ô‡∏≤‡∏à 
‡∏ü‡πâ‡∏≠‡∏á‡∏Ñ‡∏î‡∏µ  ‡πÄ‡∏Ç‡∏ï‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡∏®‡∏≤‡∏•  ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏Ñ‡∏î‡∏µ‡∏¢‡πà‡∏≠‡∏°‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏ï‡∏≤‡∏°‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏î‡∏µ  ‡∏ö‡∏ó‡∏ö‡∏±‡∏ç‡∏ç‡∏±‡∏ï‡∏¥ 
‡∏°‡∏≤‡∏ï‡∏£‡∏≤  ‡πë‡πñ‡πô  ‡πÑ‡∏°‡πà‡∏Ç‡∏±‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏¢‡πâ‡∏á‡∏ï‡πà‡∏≠‡∏£‡∏±‡∏ê‡∏ò‡∏£‡∏£‡∏°‡∏ô‡∏π‡∏ç  ‡∏°‡∏≤‡∏ï‡∏£‡∏≤  ‡πë‡πô‡πî  ‡∏ß‡∏£‡∏£‡∏Ñ‡∏´‡∏ô‡∏∂ ‡πà‡∏á  ‡∏°‡∏≤‡∏ï‡∏£‡∏≤  ‡πí‡πí‡πï  ‡πÅ‡∏•‡∏∞‡∏°‡∏≤‡∏ï‡∏£‡∏≤  ‡πí‡πí‡πñ  
‡∏ß‡∏£‡∏£‡∏Ñ‡πÄ‡∏à‡πá‡∏î
‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏°‡∏≤‡∏ï‡∏£‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
    """, context)
